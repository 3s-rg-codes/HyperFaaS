global
    log stdout format raw local0 info
    maxconn 4096
    stats socket /tmp/haproxy.sock mode 666 level admin

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

backend spoe-backend
    mode tcp
    option tcpka
    timeout connect 2s
    timeout server  60s
    server spoa1 /var/run/hyperfaas/spoe.sock

frontend grpc-in
    bind *:9090
    mode http

    filter spoe engine routing-controller-grpc config /usr/local/etc/haproxy/hyperfaas-spoe-grpc.cfg

    http-request set-header X-Routed-By %[var(txn.routing.routed_by)] if { var(txn.routing.routed_by) -m found }

    default_backend grpc-backends

backend grpc-backends
    mode http
    balance hdr(:authority)
    hash-type consistent

    use-server leaf-1 if { var(txn.routing.preferred_backend) -m str leaf-1:50050 }
    use-server leaf-2 if { var(txn.routing.preferred_backend) -m str leaf-2:50050 }

    server leaf-1 leaf-1:50050 check proto h2
    server leaf-2 leaf-2:50050 check proto h2

listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
